<?php
define('BASEPATH', str_replace('\\', '/', dirname(__FILE__)) . '/');

//РИСУЕМ БИЛЕТ
/* Создаём новый объект холста и белое изображение */
$canvas = new Imagick();
$canvas->newImage(1080, 1920, "white");

/* Устанавливаем формат PNG */
$canvas->setImageFormat('png');

/* встраиваем заготовку шапки билета */
$header_file = BASEPATH.'header.png';
$header = new Imagick($header_file);
$canvas->compositeImage($header, Imagick::COMPOSITE_DEFAULT, 0, 0);

/* настраиваем цвет и размер пикселя штрихкода */
$line_color = new ImagickPixel('#000');
$line_weight = 8.64;

$line = new ImagickDraw();

//$line->setResolution(136, 296);
$line->setStrokeWidth($line_weight);
$line->setStrokeColor($line_color);



/* генерация рандомного штрихкода построчно */
for($y==0; $y<=35; $y++)
{
	for($x==0; $x<=67; $x++)
	{
		if($x!=0 && $x!=1 && $x!=2 && $x!=3 && $x!=4 && $x!=5 && $x!=6 && $x!=7 && $x!=8 && $x!=9 && $x!=10 && $x!=11 && $x!=12 && $x!=13 && $x!=14 && $x!=15 && $x!=16 && $x!=33 && $x!=50 && $x!=67 && $x!=84)
		{
			$random = rand(0,1);
			if($random==1)
			{
				/* закрашиваем сектор 8x8 */
				$a = ($x*8.64)+172.8;
				$b = ($y*8.64)+568;
				$c = $a;
				$d = $b+8.64;
				$line->line($a, $b, $c, $d);
			}
			else{}
		}
		else{}
	}
	$x=1;
}
/* левый и правый край штрихкода 2+8+10+17+17+17+17+17+7+13 */
$line->line(17.28, 568, 17.28, 879.04);
$line->line(25.92, 568, 25.92, 879.04);
$line->line(34.56, 568, 34.56, 879.04);
$line->line(43.20, 568, 43.20, 879.04);
$line->line(51.84, 568, 51.84, 879.04);
$line->line(60.48, 568, 60.48, 879.04);
$line->line(69.12, 568, 69.12, 879.04);
$line->line(77.76, 568, 77.76, 879.04);

$line->line(95.04, 568, 95.04, 879.04);

$line->line(112.32, 568, 112.32, 879.04);

$line->line(129.60, 568, 129.60, 879.04);

$line->line(907.20, 568, 907.20, 879.04);
$line->line(915.84, 568, 915.84, 879.04);
$line->line(924.48, 568, 924.48, 879.04);
$line->line(933.12, 568, 933.12, 879.04);
$line->line(941.76, 568, 941.76, 879.04);
$line->line(950.40, 568, 950.40, 879.04);
$line->line(959.04, 568, 959.04, 879.04);

$line->line(976.32, 568, 976.32, 879.04);

$line->line(1010.88, 568, 1010.88, 879.04);

$line->line(1028.16, 568, 1028.16, 879.04);

$line->line(1054.08, 568, 1054.08, 879.04);
/**/
/* прорисовка разделителей чёрных */
$line->line(172.80, 568, 172.80, 879.04);
$line->line(319.68, 568, 319.68, 879.04);
$line->line(466.56, 568, 466.56, 879.04);
$line->line(613.44, 568, 613.44, 879.04);
$line->line(760.32, 568, 760.32, 879.04);

/* генерация константного левого блока */
$left_block = array('1','0','1','0','1','0','0','0','0','0','0','1','0','0','0','0','0','1','1','1','1','1','0','1','0','1','0','0','0','0','0','1','1','0','1','0','1','0','1','0','0','1','1','1','1','0','0','0','0','0','0','1','1','0','1','0','0','1','0','0','0','1','1','0','0','0','0','0','1','1','0','1','0','1','1','1','1','0','1','1','0','0','0','0','0','1','1','1','1','1','0','1','0','1','1','1','1','0','1','1','0','0','1','1','0','1','0','0','0','1','0','1','1','0','0','0','0','0','0','1','1','1','1','1','1','0','1','0','0','1','0','0','1','1','1','0','1','1','1','1','1','1','0','1','0','0','1','1','0','0','1','0','0','1','1','1','0','1','0','0','0','0','1','0','1','1','1','0','0','0','1','1','0','1','0','0','1','1','1','0','0','0','0','0','0','1','0','1','1','0','1','0','0','0','1','0','0','0','1','1','1','1','1','0','1','1','0','1','0','0','0','0','0','1','0','0','0','1','1','0','0','1','1','1','1','0','1','0','0','0','1','1','0','1','1','0','0','0','1','0','1','0','0','0','0','0','1','0','1','1','1','1','0','0','0','1','0','0','1','0','1','1','0','0','0','1','1','0','0','0','0','0','1','0','1','0','0','0','1','1','1','1','1','1','0','1','1','1','0','1','1','1','1','1','0','0','1','0','1','1','1','0','0','1','0','0','1','1','1','0','0','1','0','0','1','0','1','1','1','0','0','0','0','1','1','1','1','0','1','0','0','0','0','0','1','0','0','0','1','0','1','1','0','0','1','0','0','1','0','1','1','1','1','1','0','0','0','1','1','0','0','1','0','0','1','1','1','0','1','1','1','1','0','0','1','1','1','1','0','0','1','0','1','0','0','0','0','0','0','1','0','1','1','1','1','0','0','1','0','0','1','1','1','1','0','1','0','0','1','0','1','1','0','0','1','1','0','0','1','0','0','0','0','0','0','1','1','1','0','0','1','0','1','1','1','1','0','0','1','1','1','0','1','0','0','1','0','0','0','1','0','0','0','0','1','1','1','1','0','1','0','1','1','0','0','1','1','1','1','1','0','1','1','1','1','0','1','1','1','1','1','1','0','1','1','0','1','1','0','1','1','1','0','1','0','1','1','0','0','0','1','1','0','0','0','1','1','1','1','0','1','1','0','0','1','0','0','0','0','1','1','0','1','1','1','0','0','1','1','1','0','1','1','0','1','1','1','1','0','0','1','1','0','0','1','1','1','1','1','1','0','0','0','1','0','1','1','0','1','0','0','1','0','0','1','0','0','0','0','0','1','0','0','0','0','1','0','0','1','0','1','1','0','0','1','0','1','1','1','1','1','1','0','0','0','1','0','0','0','1','0','0','1','0','0','1','1','1','1','0','0','0');


$max = 16;
$zz = 0;
$xx = $zz;
for($yy==0; $yy<=35; $yy++)
{	
	$ee = 0;
	for($xx==$zz; $xx<=$max; $xx++)
	{
		
		if($left_block[$xx]==1)
		{
			/* закрашиваем сектор 8x8 */
			$aa = ($ee*8.64) + 172.8;
			$bb = ($yy*8.64) + 568;
			$cc = $aa;
			$dd = $bb + 8.64;
			$line->line($aa, $bb, $cc, $dd);
			$ee = $ee + 1;
		}
		else{$ee = $ee + 1;}
		
	}
	$max = $max + 17;
	$zz = $zz + 17;
}

/* генерация константного правого блока */
$right_block = array('1','1','1','1','1','0','1','0','1','0','1','1','1','1','1','0','0','1','1','1','1','1','0','1','0','1','0','0','0','0','0','1','1','0','1','1','1','1','1','1','0','1','0','1','1','0','1','0','0','0','0','1','1','0','1','0','1','1','1','1','0','0','1','1','1','1','1','0','1','1','0','1','0','1','1','1','1','0','1','1','0','0','0','0','0','1','1','1','0','1','0','1','1','1','1','1','0','0','0','1','0','0','1','1','1','0','1','0','0','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','1','0','1','0','0','1','0','0','1','1','1','0','1','1','1','1','1','0','1','0','0','1','1','1','0','0','1','0','0','1','0','1','0','0','0','1','1','0','0','0','0','1','1','0','0','0','1','1','0','1','0','0','1','1','1','0','0','0','0','0','0','1','0','1','1','1','1','1','0','1','0','0','0','1','1','1','0','1','0','0','1','1','0','1','0','0','0','0','1','1','1','0','1','1','1','1','0','1','1','1','1','0','1','0','0','0','1','1','0','1','1','0','0','0','1','1','1','0','0','1','0','1','0','1','1','1','1','1','1','0','0','1','0','0','1','0','1','0','0','0','0','1','0','0','0','0','0','0','1','0','1','0','0','0','1','1','1','1','1','1','0','1','1','1','0','1','1','1','0','0','1','0','1','1','1','1','1','0','0','1','0','0','1','1','0','1','1','0','1','0','0','0','1','0','0','0','0','0','0','1','1','1','1','0','1','0','0','0','0','0','1','0','0','0','1','0','1','0','0','1','0','0','1','0','0','0','0','1','1','1','1','0','0','1','1','0','0','1','0','0','1','1','0','0','1','1','1','0','0','0','1','1','1','1','0','0','1','0','1','0','0','0','0','0','0','1','0','1','1','0','0','1','0','0','1','1','1','1','1','1','0','0','1','0','1','1','1','0','1','1','0','0','1','0','0','0','0','1','1','0','0','1','1','1','0','0','1','0','1','1','1','1','0','0','1','1','1','0','1','1','1','1','1','0','1','1','0','0','1','1','1','1','0','1','0','1','0','0','1','0','0','0','1','1','0','0','0','0','1','1','0','0','1','1','1','1','1','1','0','1','1','0','1','1','0','1','1','1','0','1','0','0','1','0','0','0','0','0','1','0','1','1','1','1','0','0','1','1','0','1','1','0','0','0','1','1','0','0','1','1','0','0','0','1','1','1','0','1','1','0','1','1','1','1','0','0','1','1','0','0','1','1','1','1','0','0','0','1','0','1','1','1','1','0','1','0','0','1','1','0','0','1','0','0','0','0','0','1','0','1','1','0','0','0','1','0','1','1','0','0','1','0','1','1','1','1','1','1','0','0','0','1','1','1','1','1','1','0','0','1','1','0','1','1','1','0','1','0');

$max = 16;
$zzz = 0;
$xxx = $zzz;
for($yyy==0; $yyy<=35; $yyy++)
{	
	$eee = 0;
	for($xxx==$zzz; $xxx<=$max; $xxx++)
	{
		
		if($right_block[$xxx]==1)
		{
			/* закрашиваем сектор 8x8 */
			$aaa = ($eee*8.64) + 760.32;
			$bbb = ($yyy*8.64) + 568;
			$ccc = $aaa;
			$ddd = $bbb + 8.64;
			$line->line($aaa, $bbb, $ccc, $ddd);
			$eee = $eee + 1;
		}
		else{$eee = $eee + 1;}
		
	}
	$max = $max + 17;
	$zzz = $zzz + 17;
}



/* текстовые данные */
$draw = new ImagickDraw();
$draw->setFont(BASEPATH."Arial Bold.ttf");
$draw->setFontSize(60);
$draw->setFillColor("rgb(0,0,0)");

/* ГЕНЕРАЦИЯ НОМЕРА БИЛЕТА (примерно 7-10K билетов продаётся за сутки)*/
$date1 = date("U", mktime(07, 30, 00, 12, 14, 2018)); //не трогать
$date2 = date("U", mktime(07, 30, 00, 01, 22, 2019)); //не трогать

$min = 9300/86400; // среднесуточная продажа билетов
$current = round(date("U"));
$ticket = 1844002372040 + round(($current-$date2)*$min);
$canvas->annotateImage($draw, 460, 1007, 0, $ticket); // номер билета
$canvas->annotateImage($draw, 375, 1069, 0, 'Полный'); // тип билета детский, полный
$start = ucfirst(strtolower($_POST['start']));
$canvas->annotateImage($draw, 22, 1197, 0, $start); // станция отправления
$finish = ucfirst(strtolower($_POST['finish']));
$canvas->annotateImage($draw, 22, 1325, 0, $finish); // станция назначения
$date = date("d.m.Y");
$canvas->annotateImage($draw, 22, 1455, 0, $date); // дата поездки




$canvas->drawImage($line);
$canvas->blurImage(10,1);
$fn = 'tickets/'.$ticket.'.png';
$canvas->writeImage(BASEPATH.$fn);

/* Вывод изображения */
//header("Content-Type: image/png");
echo $fn;